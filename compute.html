<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compute &mdash; django-crunch 0.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Command Line Interface Reference" href="cli.html" />
    <link rel="prev" title="Storage" href="storage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> django-crunch
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Storage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Compute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#client-commands">Client Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stages">Stages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#workflow">Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upload">Upload</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Interface Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">django-crunch</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Compute</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/compute.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="compute">
<h1>Compute<a class="headerlink" href="#compute" title="Permalink to this headline"></a></h1>
<p>On the computational infrastructure, install django-crunch so you can use the crunch client.</p>
<section id="environment-variables">
<h2>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline"></a></h2>
<p>The crunch client needs to know how to access both the cloud server and the data storarage.
These can be set with the following environment variables:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CRUNCH_URL</span></code></dt><dd><p>The URL to the cloud server.
This can also be set with the command-line option <code class="docutils literal notranslate"><span class="pre">--url</span> <span class="pre">URL</span></code>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CRUNCH_TOKEN</span></code></dt><dd><p>The access token for a user on the cloud server.
This can be found in the admin section of the cloud server.
This variable can also be given to the client with the command-line option <code class="docutils literal notranslate"><span class="pre">--token</span> <span class="pre">TOKEN</span></code>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CRUNCH_STORAGE_SETTINGS</span></code></dt><dd><p>The path to a file with the parameters needed to instantiate the Django file storage class just as it is found on the cloud server.
This file can be in TOML format or JSON.
The values should be the same as what is in the cloud server Django settings.
This variable can also be given to the client with the command-line option <code class="docutils literal notranslate"><span class="pre">--storage-settings</span> <span class="pre">PATH/TO/SETTINGS</span></code>.</p>
</dd>
</dl>
</li>
</ul>
<p>If any of these aren’t provided as either command-line options or as environment variables, the client will prompt for the values.</p>
</section>
<section id="client-commands">
<h2>Client Commands<a class="headerlink" href="#client-commands" title="Permalink to this headline"></a></h2>
<p>To process a particular dataset, you can use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>run<span class="w"> </span>DATASET-SLUG
</pre></div>
</div>
<p>To simply process the next dataset on the cloud server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>next
</pre></div>
</div>
<p>To process the next dataset for a specific project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>next<span class="w"> </span>--project<span class="w"> </span>PROJECT-SLUG
</pre></div>
</div>
<p>To process all the remaining datasets on the cloud server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>loop
</pre></div>
</div>
<p>To process all the remaining datasets for a particular project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>loop<span class="w"> </span>--project<span class="w"> </span>PROJECT-SLUG
</pre></div>
</div>
<p>Other command line options are available. Check the command-line reference in the documentation or read the crunch client help listings. e.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>crunch<span class="w"> </span>--help
</pre></div>
</div>
</section>
<section id="stages">
<h2>Stages<a class="headerlink" href="#stages" title="Permalink to this headline"></a></h2>
<p>Processing a dataset goes through 3 stages: Setup, Workflow and Upload.
Each of these stages will send status updates to the cloud server.
The status updates are for one of the following three states: Start, Success or Fail.
A typical successful processing run for a dataset will send 6 status updates: Setup Start, Setup Success, Workflow Start, Workflow Success, Upload Start, Upload Success.
If any of the stages fail, then a <code class="docutils literal notranslate"><span class="pre">Fail</span></code> status will be sent and the processing job will stop.</p>
<section id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline"></a></h3>
<p>This involves:</p>
<ul class="simple">
<li><p>Copying the initial data from storage</p></li>
<li><p>Saving the MD5 checksums for all the initial data in <code class="docutils literal notranslate"><span class="pre">.crunch/setup_md5_checksums.json</span></code></p></li>
<li><p>Saves the metadata for the dataset in <code class="docutils literal notranslate"><span class="pre">.crunch/dataset.json</span></code></p></li>
<li><p>Saves the metadata for the project in <code class="docutils literal notranslate"><span class="pre">.crunch/project.json</span></code></p></li>
<li><p>Creates the script to run the workflow (either a bash script or a Snakefile for Snakemake)</p></li>
</ul>
</section>
<section id="workflow">
<h3>Workflow<a class="headerlink" href="#workflow" title="Permalink to this headline"></a></h3>
<p>Runs the workflow on a dataset that has been set up.</p>
<p>This involves running a bash script as a subprocess or running Snakemake with a Snakefile.</p>
</section>
<section id="upload">
<h3>Upload<a class="headerlink" href="#upload" title="Permalink to this headline"></a></h3>
<p>Uploads new or modified files to the storage for the dataset.</p>
<p>It also creates the following files:
- <code class="docutils literal notranslate"><span class="pre">.crunch/upload_md5_checksums.json</span></code> which lists all MD5 checksums after the dataset has finished.
- <code class="docutils literal notranslate"><span class="pre">.crunch/deleted.txt</span></code> which lists all files that were present after setup but which were deleted as the workflow ran.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently crunch does not delete files from the remote storage if they were deleted during the workflow.
The files are just listed in <code class="docutils literal notranslate"><span class="pre">.crunch/deleted.txt</span></code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Django storage class being used may not overwrite modified files but instead change the names slightly.
For this reason, it’s best not to modify files in the workflow section but create new files instead.
This behaviour may change in future versions of crunch.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="storage.html" class="btn btn-neutral float-left" title="Storage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cli.html" class="btn btn-neutral float-right" title="Command Line Interface Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Robert Turnbull.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>